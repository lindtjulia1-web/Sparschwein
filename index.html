<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>KGB Pirate Editor Fix</title>
    <style>
        :root { --accent: #f9e076; --bg: #1e1e24; --panel: #2a2a32; --border: #3d3d45; --green: #4caf50; --red: #f44336; }
        body { font-family: 'Segoe UI', sans-serif; background: #000; color: #fff; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 380px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 25px; }
        h2 { color: var(--accent); font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; margin: 25px 0 10px; border-left: 3px solid var(--accent); padding-left: 10px; }
        
        .card { background: rgba(0,0,0,0.2); border: 1px solid var(--border); padding: 15px; border-radius: 20px; margin-bottom: 15px; position: relative; }
        .del-btn { position: absolute; top: 12px; right: 15px; color: var(--red); cursor: pointer; font-size: 11px; }
        
        label { display: block; font-size: 10px; color: #aaa; text-transform: uppercase; margin-top: 8px; }
        input, select { width: 100%; background: #111; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 12px; margin-top: 5px; box-sizing: border-box; outline: none; }
        
        .btn { background: #3d3d45; color: #fff; border: none; padding: 14px; width: 100%; border-radius: 15px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-main { background: #ffb347; color: #000; } 
        .btn-code { background: #00d4ff; color: #000; } 

        .preview { flex: 1; background: #0c0c0e; display: flex; align-items: center; justify-content: center; }
        #device-wrapper { border: 4px solid var(--accent); position: relative; overflow: hidden; transition: 0.3s; background-size: cover; background-position: center; }
        iframe { width: 100%; height: 100%; border: none; }
        
        #code-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 100; flex-direction: column; }
        textarea { width: 80%; height: 50%; background: #111; color: var(--accent); padding: 20px; border: 1px solid var(--accent); border-radius: 20px; }
        .color-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-content">
        <h2>Запуск и Тексты</h2>
        <label>Заголовок при запуске</label>
        <input type="text" id="start-title" value="Готовы к игре?">
        <label>Текст кнопки запуска</label>
        <input type="text" id="start-btn-text" value="НАЧАТЬ">
        <label>Цвет текста</label>
        <input type="color" id="textColor" value="#ffffff">

        <h2>Эффекты билборда</h2>
        <div class="color-grid">
            <div><label>Цвет рамки</label><input type="color" id="borderColor" value="#f9e076"></div>
            <div><label>Толщина (px)</label><input type="number" id="borderWidth" value="4"></div>
        </div>
        <label>Закругление (px)</label>
        <input type="range" id="borderRadius" min="0" max="150" value="40">
        <label>Свечение</label>
        <input type="number" id="shadowBlur" value="15">

        <h2>Оформление</h2>
        <label>Фон (URL картинки)</label>
        <input type="text" id="bg-url" placeholder="https://..." value="">
        <label>Шрифт</label>
        <select id="fontFamily">
            <option value="'Montserrat', sans-serif">Montserrat</option>
            <option value="'Segoe UI', sans-serif">Segoe UI</option>
            <option value="'Acme', sans-serif">Acme</option>
        </select>
        <label>Размер шрифта (px)</label>
        <input type="range" id="fontSize" min="12" max="32" value="20">

        <h2>Цвета интерфейса</h2>
        <div class="color-grid">
            <div><label>Цвет кнопок</label><input type="color" id="btnColor" value="#f9e076"></div>
            <div><label>Прозрачность</label><input type="range" id="btnAlpha" min="0" max="1" step="0.1" value="0.2"></div>
        </div>
        <label>Язык интерфейса</label>
        <select id="lang">
            <option value="ru">Русский</option>
            <option value="en">English</option>
            <option value="de">Deutsch</option>
        </select>

        <h2>Размер виджета</h2>
        <div class="color-grid">
            <input type="number" id="width" value="400">
            <input type="number" id="height" value="600">
        </div>

        <h2>Вопросы</h2>
        <div id="q-container"></div>
        <button class="btn" onclick="addQ()">+ ДОБАВИТЬ ВОПРОС</button>
    </div>
    
    <div style="padding: 20px; border-top: 1px solid var(--border);">
        <button class="btn btn-main" onclick="updatePreview()">ОБНОВИТЬ ПРЕВЬЮ</button>
        <button class="btn btn-code" onclick="getGeniallyCode()">ПОЛУЧИТЬ КОД</button>
    </div>
</div>

<div class="preview">
    <div id="device-wrapper"><iframe id="ifr"></iframe></div>
</div>

<div id="code-modal">
    <textarea id="result-code" readonly></textarea>
    <button class="btn" onclick="document.getElementById('code-modal').style.display='none'" style="width: 200px">ЗАКРЫТЬ</button>
</div>

<script>
// Вспомогательная функция для HEX -> RGBA
function hexToRgba(hex, alpha) {
    let r = parseInt(hex.slice(1, 3), 16),
        g = parseInt(hex.slice(3, 5), 16),
        b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

function addQ(qText = "2 + 2 = ?", correct = "4", wrongs = ["3", "5"]) {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
        <span class="del-btn" onclick="this.parentElement.remove()">УДАЛИТЬ</span>
        <label>Вопрос</label><input type="text" class="inp-q" value="${qText}">
        <label style="color:var(--green)">Верный ответ</label><input type="text" class="inp-correct" value="${correct}">
        <label style="color:var(--red)">Ложные (через запятую)</label><input type="text" class="inp-wrong" value="${wrongs.join(', ')}">
    `;
    document.getElementById('q-container').appendChild(div);
}

function buildInnerGame() {
    const questions = [];
    document.querySelectorAll('.card').forEach(card => {
        const q = card.querySelector('.inp-q').value;
        const correct = card.querySelector('.inp-correct').value.trim();
        const wrongs = card.querySelector('.inp-wrong').value.split(',').map(s => s.trim());
        if(q && correct) questions.push({ q, a: [correct, ...wrongs] });
    });

    const cfg = {
        bg: document.getElementById('bg-url').value,
        radius: document.getElementById('borderRadius').value,
        startTitle: document.getElementById('start-title').value,
        startBtn: document.getElementById('start-btn-text').value,
        textColor: document.getElementById('textColor').value,
        borderColor: document.getElementById('borderColor').value,
        borderWidth: document.getElementById('borderWidth').value,
        shadowBlur: document.getElementById('shadowBlur').value,
        lang: document.getElementById('lang').value,
        font: document.getElementById('fontFamily').value,
        fontSize: document.getElementById('fontSize').value,
        btnColor: document.getElementById('btnColor').value,
        btnRgba: hexToRgba(document.getElementById('btnColor').value, document.getElementById('btnAlpha').value),
        coinUrl: "https://r.jina.ai/i/0582d96c808b490fbc23315a6766627a",
        data: questions
    };

    return `<!DOCTYPE html><html><head><meta charset="UTF-8">
    <style>
        body { margin:0; height:100vh; font-family:${cfg.font}; background:transparent; color:${cfg.textColor}; overflow:hidden; }
        .game-shell { 
            position:relative; width:100%; height:100%; 
            border:${cfg.borderWidth}px solid ${cfg.borderColor}; 
            border-radius:${cfg.radius}px; box-sizing:border-box;
            background: url('${cfg.bg}') center/cover no-repeat;
            box-shadow: 0 0 ${cfg.shadowBlur}px ${cfg.borderColor};
        }
        .overlay { position:absolute; inset:0; background:rgba(0,0,0,0.4); border-radius:${cfg.radius}px; z-index:1; }
        .content { position:relative; z-index:2; height:100%; display:flex; flex-direction:column; padding:20px; text-align:center; justify-content: space-between; }
        .score { font-size:40px; font-weight:bold; color:${cfg.btnColor}; }
        .btn-ans, .btn-start { 
            background:${cfg.btnRgba}; border:2px solid ${cfg.btnColor}; color:${cfg.btnColor}; 
            padding:15px; border-radius:15px; margin:5px; cursor:pointer; font-weight:bold; font-size:16px;
        }
        .coin { position:absolute; width:40px; z-index:10; }
        .screen { position:absolute; inset:0; display:none; flex-direction:column; justify-content:center; align-items:center; z-index:20; background:rgba(0,0,0,0.8); border-radius:${cfg.radius}px; }
        .active { display:flex; }
    </style></head><body>
    <div class="game-shell">
        <div class="overlay"></div>
        <div id="start-screen" class="screen active">
            <h1>${cfg.startTitle}</h1>
            <button class="btn-start" onclick="start()"> ${cfg.startBtn} </button>
        </div>
        <div class="content">
            <div class="score" id="s">0</div>
            <div id="coins-area" style="flex:1; position:relative;"></div>
            <div id="q-text" style="margin-bottom:10px; font-weight:bold;"></div>
            <div id="ans-grid" style="display:grid; gap:5px;"></div>
        </div>
    </div>
    <script>
        const cfg = JSON.parse(decodeURIComponent("${encodeURIComponent(JSON.stringify(cfg))}"));
        let score=0, qi=0;
        
        function start() { document.getElementById('start-screen').classList.remove('active'); showQ(); }

        function showQ() {
            if(qi >= cfg.data.length) { document.getElementById('q-text').innerText = "ФИНИШ"; return; }
            const q = cfg.data[qi];
            document.getElementById('q-text').innerText = q.q;
            const grid = document.getElementById('ans-grid');
            grid.innerHTML = '';
            [...q.a].sort(() => Math.random()-0.5).forEach(txt => {
                const b = document.createElement('button');
                b.className = 'btn-ans'; b.innerText = txt;
                b.onclick = () => {
                    if(txt === q.a[0]) { score += 50; drop(); }
                    document.getElementById('s').innerText = score;
                    qi++; setTimeout(showQ, 600);
                };
                grid.appendChild(b);
            });
        }

        function drop() {
            for(let i=0; i<5; i++) {
                const c = document.createElement('img');
                c.src = cfg.coinUrl; c.className = 'coin';
                c.style.left = Math.random()*80 + '%'; c.style.top = '-40px';
                document.getElementById('coins-area').appendChild(c);
                c.animate([{top:'-40px'}, {top:'90%'}], {duration:800+Math.random()*400, fill:'forwards'});
            }
        }
    <\/script></body></html>`;
}

function updatePreview() {
    const wrap = document.getElementById('device-wrapper');
    wrap.style.width = document.getElementById('width').value + 'px';
    wrap.style.height = document.getElementById('height').value + 'px';
    wrap.style.borderRadius = document.getElementById('borderRadius').value + 'px';
    wrap.style.borderColor = document.getElementById('borderColor').value;
    
    document.getElementById('ifr').srcdoc = buildInnerGame();
}

function getGeniallyCode() {
    const html = buildInnerGame().replace(/"/g, '&quot;');
    document.getElementById('result-code').value = `<iframe width="100%" height="100%" srcdoc="${html}" frameborder="0"></iframe>`;
    document.getElementById('code-modal').style.display = 'flex';
}

window.onload = () => { addQ(); updatePreview(); };
</script>
</body>
</html>
