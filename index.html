<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>KGB Pile Editor Pro + Stakes</title>
    <style>
        :root { --accent: #f9e076; --bg: #1e1e24; --panel: #2a2a32; --border: #3d3d45; --green: #4caf50; --red: #f44336; }
        body { font-family: 'Segoe UI', sans-serif; background: #000; color: #fff; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 380px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 25px; }
        h2 { color: var(--accent); font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; margin: 25px 0 10px; border-left: 3px solid var(--accent); padding-left: 10px; }
        
        .card { background: rgba(0,0,0,0.2); border: 1px solid var(--border); padding: 15px; border-radius: 20px; margin-bottom: 15px; position: relative; }
        .del-btn { position: absolute; top: 12px; right: 15px; color: var(--red); cursor: pointer; font-weight: bold; font-size: 11px; }
        
        .sidebar-content label { display: block; font-size: 10px; color: #aaa; text-transform: uppercase; margin-top: 8px; }
        .sidebar-content input, .sidebar-content select { width: 100%; background: #111; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 12px; margin-top: 5px; box-sizing: border-box; outline: none; }
        
        .btn { background: #3d3d45; color: #fff; border: none; padding: 14px; width: 100%; border-radius: 15px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.3s; }
        .btn-main { background: #ffb347; color: #000; margin-top: 20px; } 
        .btn-code { background: #77dd77; color: #000; margin-top: 8px; } 

        .preview { flex: 1; background: #0c0c0e; display: flex; align-items: center; justify-content: center; }
        #device-wrapper { border: 1px solid #333; background: #000; position: relative; overflow: hidden; border-radius: 30px; transition: 0.3s; background-size: cover; background-position: center; }
        iframe { width: 100%; height: 100%; border: none; background: transparent; }
        
        #code-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 100; flex-direction: column; }
        textarea { width: 80%; height: 50%; background: #111; color: var(--accent); padding: 20px; border: 1px solid var(--accent); border-radius: 20px; font-family: monospace; }
        
        .color-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        input[type="color"] { padding: 2px; height: 38px; cursor: pointer; border-radius: 10px; }

        @keyframes billboard { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.3) drop-shadow(0 0 10px var(--shad)); } }
        .anim-border { animation: billboard 2s infinite ease-in-out; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-content">
        <h2>Запуск</h2>
        <label>Заголовок</label>
        <input type="text" id="start-title" value="Сокровища Пирата">
        <label>Кнопка старта</label>
        <input type="text" id="start-btn-text" value="В БОЙ">
        
        <h2>Визуал (URL картинок)</h2>
        <label>Картинка копилки</label>
        <input type="text" id="pig-img-url" placeholder="https://..." value="https://cdn-icons-png.flaticon.com/512/2353/2353594.png" onchange="updatePreview()">
        <label>Картинка монетки</label>
        <input type="text" id="coin-img-url" placeholder="https://..." value="https://cdn-icons-png.flaticon.com/512/1055/1055833.png" onchange="updatePreview()">

        <h2>Оформление</h2>
        <label>Фон (URL)</label>
        <input type="text" id="bg-url" placeholder="https://..." onchange="updatePreview()">
        <label>Шрифт</label>
        <select id="fontFamily" onchange="updatePreview()">
            <option value="'Segoe UI', sans-serif">Segoe UI</option>
            <option value="'ABeeZee', sans-serif">ABeeZee</option>
            <option value="'Aclonica', sans-serif">Aclonica</option>
            <option value="'Acme', sans-serif">Acme</option>
            <option value="'Georgia', serif">Georgia</option>
        </select>
        <label>Базовый размер текста (%)</label>
        <input type="range" id="fontSize" min="3" max="6" step="0.1" value="4.5" oninput="updatePreview()">
        <label>Закругление углов (px)</label>
        <input type="range" id="borderRadius" min="0" max="60" value="30" oninput="updatePreview()">

        <h2>Отступы (vmin)</h2>
        <div class="color-grid">
            <div><label>Верх</label><input type="range" id="padT" min="0" max="15" value="4" oninput="updatePreview()"></div>
            <div><label>Низ</label><input type="range" id="padB" min="0" max="15" value="4" oninput="updatePreview()"></div>
            <div><label>Слева</label><input type="range" id="padL" min="0" max="15" value="4" oninput="updatePreview()"></div>
            <div><label>Справа</label><input type="range" id="padR" min="0" max="15" value="4" oninput="updatePreview()"></div>
        </div>

        <h2>Экран</h2>
        <div class="color-grid">
            <input type="number" id="width" value="400" onchange="updatePreview()">
            <input type="number" id="height" value="600" onchange="updatePreview()">
        </div>

        <h2>Алгоритм</h2>
        <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
            <input type="checkbox" id="isRandom" style="width:auto; margin:0;" checked> Случайный порядок вопросов
        </label>

        <h2>Вопросы</h2>
        <div id="q-container"></div>
        <button class="btn" onclick="addQ()">+ ДОБАВИТЬ ВОПРОС</button>

        <label>Язык виджета</label>
        <select id="lang">
            <option value="ru">Русский</option>
            <option value="en">English</option>
            <option value="de">Deutsch</option>
        </select>

        <input type="hidden" id="shadowColor" value="#f9e076">
    </div>
    <div style="padding: 20px; border-top: 1px solid var(--border);">
        <button class="btn btn-main" onclick="updatePreview()">ОБНОВИТЬ ПРЕВЬЮ</button>
        <button class="btn btn-code" onclick="getGeniallyCode()">ПОЛУЧИТЬ КОД</button>
    </div>
</div>

<div class="preview">
    <div id="device-wrapper" class="anim-border"><iframe id="ifr"></iframe></div>
</div>

<div id="code-modal">
    <textarea id="result-code" readonly onclick="this.select()"></textarea>
    <button class="btn" onclick="document.getElementById('code-modal').style.display='none'" style="width: 200px">ЗАКРЫТЬ</button>
</div>

<script>
function addQ(q, c, w) {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<span class="del-btn" onclick="this.parentElement.remove()">УДАЛИТЬ</span>
        <label>Вопрос</label><input type="text" class="inp-q" value="${q||''}">
        <label style="color:var(--green)">✓ Верный</label><input type="text" class="inp-correct" value="${c||''}">
        <label style="color:var(--red)">× Ложные</label><input type="text" class="inp-wrong" value="${w||''}">`;
    document.getElementById('q-container').appendChild(div);
}

function buildInnerGame() {
    const data = Array.from(document.querySelectorAll('.card')).map(c => ({
        q: c.querySelector('.inp-q').value,
        a: [c.querySelector('.inp-correct').value, ...c.querySelector('.inp-wrong').value.split(',').map(x => x.trim())]
    })).filter(x => x.q);

    const cfg = {
        bg: document.getElementById('bg-url').value,
        title: document.getElementById('start-title').value,
        btn: document.getElementById('start-btn-text').value,
        pigImg: document.getElementById('pig-img-url').value,
        coinImg: document.getElementById('coin-img-url').value,
        fz: document.getElementById('fontSize').value,
        br: document.getElementById('borderRadius').value,
        ff: document.getElementById('fontFamily').value,
        rnd: document.getElementById('isRandom').checked,
        lang: document.getElementById('lang').value,
        pt: document.getElementById('padT').value,
        pb: document.getElementById('padB').value,
        pl: document.getElementById('padL').value,
        pr: document.getElementById('padR').value,
        data: data
    };

    return `<!DOCTYPE html><html><head><meta charset="UTF-8">
    <style>
        body { margin:0; height:100vh; overflow:hidden; font-family:${cfg.ff}; background:#000; color:#fff; border:4px solid #f9e076; box-sizing:border-box; border-radius:${cfg.br}px; }
        .bg { position:fixed; inset:0; background:url(${cfg.bg}) center/cover; opacity:0.4; z-index:-1; }
        #root { height:100%; display:flex; flex-direction:column; padding:${cfg.pt}vmin ${cfg.pr}vmin ${cfg.pb}vmin ${cfg.pl}vmin; position:relative; box-sizing:border-box; }
        .score { font-size:10vmin; color:#f9e076; font-weight:900; text-align:center; margin-bottom:2vmin; z-index:20; }
        #pile-box { flex:1; position:relative; display:flex; justify-content:center; align-items:center; }
        .pig { width:65vmin; height:auto; z-index:10; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.5)); object-fit: contain; pointer-events: none; }
        /* Контейнер кучи теперь жестко привязан к центру свинки */
        .coins { position:absolute; left: 50%; top: 50%; transform: translate(-50%, -40%); width:30vmin; height:20vmin; z-index:5; pointer-events:none; }
        .stored-coin { position:absolute; width:6vmin; height:6vmin; background:url(${cfg.coinImg}) center/cover no-repeat; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.4)); }
        .falling-coin { position:absolute; left:50%; width:10vmin; height:10vmin; z-index:15; background:url(${cfg.coinImg}) center/cover no-repeat; pointer-events:none; }
        .ui { min-height:35%; display:flex; flex-direction:column; justify-content:flex-end; padding-bottom:2vmin; z-index:20; }
        .label { font-size:${cfg.fz}vmin; text-align:center; margin-bottom:3vmin; font-weight:bold; min-height:3em; display:flex; align-items:center; justify-content:center; }
        .grid { display:grid; gap:2vmin; }
        button { border:2px solid #f9e076; background:rgba(0,0,0,0.6); color:#f9e076; padding:3vmin; border-radius:15px; cursor:pointer; font-weight:bold; font-size:4vmin; transition:0.2s; }
        button:hover { background:rgba(249,224,118,0.2); }
        .screen { position:absolute; inset:0; background:rgba(0,0,0,0.95); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:100; text-align:center; padding:5vmin; border-radius:${cfg.br}px; }
        @keyframes fall { 
            0% { transform:translate(-50%,-60vmin) rotate(0deg); opacity:0; } 
            20% { opacity:1; } 
            100% { transform:translate(-50%,0vmin) rotate(180deg); opacity:0.9; } 
        }
    </style></head><body>
        <div class="bg"></div>
        <div id="root">
            <div id="start-sc" class="screen"><h2>${cfg.title}</h2><button onclick="start()">${cfg.btn}</button></div>
            <div class="score" id="score-val">0</div>
            <div id="pile-box">
                <img src="${cfg.pigImg}" class="pig">
                <div class="coins" id="coin-pile"></div>
            </div>
            <div class="ui">
                <div class="label" id="q-label"></div>
                <div id="btn-grid" class="grid"></div>
            </div>
        </div>
    <script>
        let qi=0, score=0, stake=0, coinCount=0; 
        let rawData = ${JSON.stringify(cfg.data)};
        const data = ${cfg.rnd} ? rawData.sort(() => Math.random() - 0.5) : rawData;
        const dict = {
            ru: { stake: "ВЫБЕРИТЕ СТАВКУ", finish: "ИГРА ОКОНЧЕНА!" },
            en: { stake: "CHOOSE STAKE", finish: "GAME OVER!" },
            de: { stake: "EINSATZ WÄHLEN", finish: "SPIEL BEENDET!" }
        }['${cfg.lang}'];

        function start() { document.getElementById('start-sc').style.display='none'; showStakes(); }

        function showStakes() {
            if(qi >= data.length) { finish(); return; }
            document.getElementById('q-label').innerText = dict.stake;
            const g = document.getElementById('btn-grid');
            g.innerHTML = '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1vmin"></div>';
            [10,25,50,100].forEach(v => {
                const b = document.createElement('button'); b.innerText = v;
                b.style.fontSize = "3vmin";
                b.onclick = () => { stake = v; showQ(); }; g.firstChild.appendChild(b);
            });
        }

        function showQ() {
            document.getElementById('q-label').innerText = data[qi].q;
            const g = document.getElementById('btn-grid'); g.innerHTML = '';
            [...data[qi].a].sort(()=>Math.random()-0.5).forEach(t => {
                const b = document.createElement('button'); b.innerText = t;
                b.onclick = () => {
                    if(t === data[qi].a[0]) { score += stake; drop(Math.ceil(stake/10)); }
                    else { score = Math.max(0, score - stake); remove(Math.ceil(stake/10)); }
                    document.getElementById('score-val').innerText = score;
                    qi++; setTimeout(showStakes, 1500);
                }; g.appendChild(b);
            });
        }

        function drop(n) {
            for(let i=0; i<n; i++) {
                setTimeout(() => {
                    const f = document.createElement('div'); f.className = 'falling-coin';
                    document.getElementById('coin-pile').appendChild(f);
                    f.style.animation = 'fall 0.6s ease-in forwards';
                    setTimeout(() => { f.remove(); add(); }, 550);
                }, i*80);
            }
        }

        function add() {
            coinCount++;
            const p = document.getElementById('coin-pile');
            const s = document.createElement('div'); s.className = 'stored-coin';
            
            // Физика горки (центровка x и рост y)
            const spread = 12; // Ширина основания горки
            const randX = (Math.random() + Math.random() + Math.random() - 1.5) / 1.5; 
            const x = randX * spread; 
            
            // Высота кучи: чем ближе к центру (randX -> 0), тем выше горка
            const coneHeight = (1 - Math.abs(randX)) * 4; 
            const growth = Math.min(10, coinCount * 0.12); // Плавный рост всей кучи вверх
            const y = coneHeight + growth;

            s.style.left = (15 + x - 3) + 'vmin'; // 15 - половина ширины контейнера (30/2)
            s.style.bottom = y + 'vmin';
            s.style.transform = 'rotate(' + (Math.random() * 60 - 30) + 'deg)';
            s.style.zIndex = coinCount; 
            
            p.appendChild(s);
        }

        function remove(n) {
            const p = document.getElementById('coin-pile');
            for(let i=0; i<n; i++) {
                if(p.lastChild) {
                    p.lastChild.remove();
                    coinCount = Math.max(0, coinCount - 1);
                }
            }
        }

        function finish() {
            document.getElementById('q-label').innerText = dict.finish;
            document.getElementById('btn-grid').innerHTML = '<button onclick="location.reload()">RESTART</button>';
        }
    <\/script></body></html>`;
}

function updatePreview() {
    const dev = document.getElementById('device-wrapper');
    dev.style.width = document.getElementById('width').value + 'px';
    dev.style.height = document.getElementById('height').value + 'px';
    dev.style.borderRadius = document.getElementById('borderRadius').value + 'px';
    dev.style.setProperty('--shad', document.getElementById('shadowColor').value);
    const bgUrl = document.getElementById('bg-url').value;
    dev.style.backgroundImage = bgUrl ? `url(${bgUrl})` : 'none';
    document.getElementById('ifr').srcdoc = buildInnerGame();
}

function getGeniallyCode() {
    const html = buildInnerGame().replace(/"/g, '&quot;');
    document.getElementById('result-code').value = `<iframe width="100%" height="100%" srcdoc="${html}" frameborder="0" scrolling="no" style="border:none;overflow:hidden;border-radius:${document.getElementById('borderRadius').value}px;"></iframe>`;
    document.getElementById('code-modal').style.display = 'flex';
}

window.onload = () => { 
    addQ('Кто написал Остров Сокровищ?', 'Стивенсон', 'Дефо, Лондон');
    updatePreview(); 
};
</script>
</body>
</html>
